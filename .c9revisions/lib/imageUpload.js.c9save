{"ts":1354607147879,"silentsave":true,"restoring":false,"patch":[[]],"length":0}
{"contributors":[],"silentsave":false,"ts":1354607691720,"patch":[[{"diffs":[[1,"var Db = require('mongodb').Db;\r\nvar Connection = require('mongodb').Connection;\r\nvar Server = require('mongodb').Server;\r\nvar BSON = require('mongodb').BSON;\r\nvar ObjectID = require('mongodb').ObjectID;\r\nvar GridStore = require('mongodb').GridStore;\r\n\r\nImageFileProvider = function (dburl) {\r\n    this.db = new Db(dburl);\r\n};\r\n\r\nImageFileProvider.prototype.insert = function (data, callback) {\r\n    //process.nextTick(function(){\r\n        var gridStore = new GridStore(this.db, new ObjectID(), 'w', {\"content_type\":\"image/png\",\"chunk_size\":data.length});\r\n        gridStore.open(function (err, gridStore) {\r\n            gridStore.write(data, function () {\r\n                gridStore.close(function (err, result) {\r\n                    if (err) {\r\n                        console.log(err);\r\n                    } else {\r\n                        console.log('insert ok.');\r\n                        callback(result);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n    //});\r\n};\r\n\r\nImageFileProvider.prototype.read = function (fileId, callback) {\r\n    console.log('read ...'+fileId);\r\n    var gridStore = new GridStore(this.db, new ObjectID(fileId));\r\n    console.log('gridStore ...'+gridStore);\r\n    gridStore.open(function (err, gridStore) {\r\n        if(err){\r\n            console.log(err);\r\n        }else{\r\n            console.log('open ...');\r\n            gridStore.read(function (err, data) {\r\n                if (err) {\r\n                    console.log(err);\r\n                } else {\r\n                    console.log('read ok');\r\n                    callback(data);\r\n                }\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\nexports.ImageFileProvider = ImageFileProvider;"]],"start1":0,"start2":0,"length1":0,"length2":1707}]],"length":1707,"saved":false}
{"ts":1354607902092,"patch":[[{"diffs":[[0,"idStore;\r\n\r\n"],[1,"var "],[0,"ImageFilePro"]],"start1":242,"start2":242,"length1":24,"length2":28}]],"length":1711,"saved":false}
{"contributors":[],"silentsave":false,"ts":1354612978466,"patch":[[{"diffs":[[0,"var "],[-1,"Db"],[1,"mongoose"],[0," = requi"]],"start1":0,"start2":0,"length1":14,"length2":20},{"diffs":[[0,"ire("],[-1,"'mongodb').Db;\r\nvar"],[1,"\"mongoose\")\r\n,mongodb = mongoose.mongo\r\nvar Db = mongodb.Db\r\n,  "],[0," Con"]],"start1":19,"start2":19,"length1":27,"length2":72},{"diffs":[[0,"ction = "],[-1,"require('"],[0,"mongodb"],[-1,"')"],[0,".Connect"]],"start1":93,"start2":93,"length1":34,"length2":23},{"diffs":[[0,"nnection"],[-1,";"],[0,"\r\n"],[-1,"var"],[1,",  "],[0," Server "]],"start1":111,"start2":111,"length1":22,"length2":21},{"diffs":[[0,"r = "],[-1,"require('"],[0,"mongodb"],[-1,"')"],[0,".Server"],[-1,";"],[0,"\r\n"],[-1,"var"],[1,",  "],[0," BSON = "],[-1,"require('"],[0,"mongodb"],[-1,"')"],[0,".BSON"],[-1,";"],[0,"\r\n"],[-1,"var"],[1,",  "],[0," Obj"]],"start1":130,"start2":130,"length1":76,"length2":52},{"diffs":[[0,"ectID = "],[-1,"require('"],[0,"mongodb"],[-1,"')"],[0,".ObjectI"]],"start1":182,"start2":182,"length1":34,"length2":23},{"diffs":[[0,"ctID"],[-1,";"],[0,"\r\n"],[-1,"var"],[1,",  "],[0," Gri"]],"start1":202,"start2":202,"length1":14,"length2":13},{"diffs":[[0,"e = "],[-1,"require('"],[0,"mongodb"],[-1,"')"],[0,".Gri"]],"start1":220,"start2":220,"length1":26,"length2":15},{"diffs":[[0,"ridStore"],[-1,";"],[1,"\r\n\r\nvar host = \"127.0.0.1\"\r\n,   port = 27017\r\n,   db = \"iroundu\""],[0,"\r\n\r\nvar "]],"start1":233,"start2":233,"length1":17,"length2":80},{"diffs":[[0,"ar Image"],[-1,"FileProvider"],[1,"Upload"],[0," = funct"]],"start1":310,"start2":310,"length1":28,"length2":22},{"diffs":[[0,"nction ("],[-1,"dburl"],[0,") {\r\n   "]],"start1":329,"start2":329,"length1":21,"length2":16},{"diffs":[[0," Db("],[-1,"dburl);\r\n};\r\n\r\nImageFileProvider"],[1,"this.db, new Server(this.host, this.port, {auto_reconnect:true}, {}));\r\n};\r\n\r\nImageUpload.prototype.setup = function(host,port,db){\r\n    this.host = host\r\n    this.port = port\r\n    this.db = db\r\n}\r\n\r\nImageUpload"],[0,".pro"]],"start1":359,"start2":359,"length1":40,"length2":219},{"diffs":[[0,"age/"],[1,"j"],[0,"p"],[-1,"n"],[0,"g\",\""]],"start1":746,"start2":746,"length1":10,"length2":10},{"diffs":[[0,"\n\r\nImage"],[-1,"FileProvider"],[1,"Upload"],[0,".prototy"]],"start1":1231,"start2":1231,"length1":28,"length2":22},{"diffs":[[0,"mage"],[-1,"FileProvider = ImageFileProvider"],[1,"Upload = ImageUpload"],[0,";"]],"start1":1891,"start2":1891,"length1":37,"length2":25}]],"length":1916,"saved":false}
{"ts":1354613235392,"patch":[[{"diffs":[[0,"ction () {\r\n"],[1,"    console.log(this.db)\r\n"],[0,"    this.db "]],"start1":330,"start2":330,"length1":24,"length2":50}]],"length":1942,"saved":false}
{"ts":1354613348789,"patch":[[{"diffs":[[0,"tore\r\n\r\n"],[-1,"var "],[1,"this."],[0,"host = \""]],"start1":237,"start2":237,"length1":20,"length2":21},{"diffs":[[0,"1\"\r\n,   "],[1,"this."],[0,"port = 2"]],"start1":266,"start2":266,"length1":16,"length2":21},{"diffs":[[0,"17\r\n,   "],[1,"this."],[0,"db = \"ir"]],"start1":289,"start2":289,"length1":16,"length2":21}]],"length":1953,"saved":false}
{"ts":1354613431130,"patch":[[{"diffs":[[0,"\r\n\r\n"],[-1,"this.host = \"127.0.0.1\"\r\n,   this.port = 27017\r\n,   this.db = \"iroundu\"\r\n"],[0,"\r\nva"]],"start1":241,"start2":241,"length1":81,"length2":8},{"diffs":[[0," new Db("],[-1,"this.db"],[1,"'iroundu'"],[0,", new Se"]],"start1":319,"start2":319,"length1":23,"length2":25},{"diffs":[[0,"ver("],[-1,"this."],[1,"\"local"],[0,"host"],[1,"\""],[0,", "],[-1,"this.port"],[1,"27017"],[0,", {a"]],"start1":345,"start2":345,"length1":28,"length2":26},{"diffs":[[0,"\r\n\r\n"],[-1,"ImageUpload.prototype.setup = function(host,port,db){\r\n    this.host = host\r\n    this.port = port\r\n    this.db = db\r\n}\r\n\r\n"],[0,"Imag"]],"start1":401,"start2":401,"length1":130,"length2":8}]],"length":1758,"saved":false}
{"ts":1354613482332,"patch":[[{"diffs":[[0," {\r\n"],[-1,"    console.log(this.db)\r\n"],[0,"    "]],"start1":276,"start2":276,"length1":34,"length2":8}]],"length":1732,"saved":false}
{"contributors":[],"silentsave":false,"ts":1354616502455,"patch":[[{"diffs":[[0,"pe\":"],[-1,"\"image/jpg\""],[1,"data.type"],[0,",\"ch"]],"start1":555,"start2":555,"length1":19,"length2":17},{"diffs":[[0," {\r\n"],[-1,"    console.log('read ...'+fileId);\r\n"],[0,"    "]],"start1":1104,"start2":1104,"length1":45,"length2":8},{"diffs":[[0,");\r\n"],[-1,"    console.log('gridStore ...'+gridStore);\r\n"],[0,"    "]],"start1":1171,"start2":1171,"length1":53,"length2":8},{"diffs":[[0,"e{\r\n"],[-1,"            console.log('open ...');\r\n"],[0,"    "]],"start1":1284,"start2":1284,"length1":46,"length2":8},{"diffs":[[0,"sole.log(err);\r\n"],[1,""],[0,"                "]],"start1":1390,"start2":1390,"length1":32,"length2":32},{"diffs":[[0," {\r\n"],[-1,"                    console.log('read ok');\r\n"],[0,"    "]],"start1":1428,"start2":1428,"length1":53,"length2":8}]],"length":1565,"saved":false}
{"ts":1354620194139,"patch":[[{"diffs":[[0," {\r\n"],[-1,"                        console.log('insert ok.');\r\n"],[0,"    "]],"start1":858,"start2":858,"length1":60,"length2":8}]],"length":1513,"saved":false}
{"contributors":[],"silentsave":false,"ts":1354624255968,"patch":[[{"diffs":[[0,"Db\r\n"],[-1,",   Connection = mongodb.Connection\r\n"],[0,",   "]],"start1":80,"start2":80,"length1":45,"length2":8},{"diffs":[[0,"ze\":"],[-1,"data.length"],[1,"1024"],[0,"});\r"]],"start1":541,"start2":541,"length1":19,"length2":12},{"diffs":[[0,"(fileId)"],[1,",'r'"],[0,");\r\n    "]],"start1":1067,"start2":1067,"length1":16,"length2":20}]],"length":1473,"saved":false}
{"ts":1354628285759,"patch":[[{"diffs":[[0,"unction(){\r\n"],[1,"        var fileId = new ObjectID();\r\n"],[0,"        var "]],"start1":426,"start2":426,"length1":24,"length2":62},{"diffs":[[0,"this.db,"],[-1," new ObjectID()"],[1,"fileId "],[0,", 'w', {"]],"start1":514,"start2":514,"length1":31,"length2":23},{"diffs":[[0,"ze\":"],[-1,"1024"],[1,"data.length"],[0,"});\r"]],"start1":571,"start2":571,"length1":12,"length2":19},{"diffs":[[0,"sole.log(err);\r\n"],[-1,""],[0,"                "]],"start1":809,"start2":809,"length1":32,"length2":32},{"diffs":[[0,"      } else {\r\n"],[1,"                         GridStore.exist(this.db,fileId , function(err, result) {\r\n                          console.log('store file '+fileId+\" status :\"+result)\r\n                          this.db.close();\r\n                        });\r\n"],[0,"                "]],"start1":839,"start2":839,"length1":32,"length2":268}]],"length":1746,"saved":false}
{"ts":1354629131692,"patch":[[{"diffs":[[0,"data, function ("],[1,"err,gridStore"],[0,") {\r\n           "]],"start1":671,"start2":671,"length1":32,"length2":45},{"diffs":[[0,"        "],[-1," "],[0,"GridStor"]],"start1":884,"start2":884,"length1":17,"length2":16},{"diffs":[[0,"err, result) {\r\n"],[-1,"  "],[0,"                "]],"start1":934,"start2":934,"length1":34,"length2":32},{"diffs":[[0,"    "],[-1,"this.db.close();"],[0,"\r\n  "]],"start1":1050,"start2":1050,"length1":24,"length2":8}]],"length":1740,"saved":false}
{"ts":1354629306997,"patch":[[{"diffs":[[0,"    "],[-1,"gridStore.read(function (err, data) {\r\n                if (err) {\r\n                    console.log(err);\r\n                } else"],[1,"// Set the pointer of the read head to the start of the gridstored file\r\n            gridStore.seek(0, function() {\r\n                // Read the entire file\r\n                gridStore.read(function(err, data2)"],[0," {\r\n"]],"start1":1471,"start2":1471,"length1":136,"length2":217},{"diffs":[[0,"ack(data"],[1,"2"],[0,")"],[-1,";"],[0,"\r\n      "]],"start1":1713,"start2":1713,"length1":18,"length2":18},{"diffs":[[0,"               }"],[1,");"],[0,"\r\n            })"]],"start1":1726,"start2":1726,"length1":32,"length2":34},{"diffs":[[0,"\r\n            })"],[-1,";"],[0,"\r\n        }\r\n   "]],"start1":1744,"start2":1744,"length1":33,"length2":32}]],"length":1822,"saved":false}
{"ts":1354629494198,"patch":[[{"diffs":[[0,"rr, data"],[-1,"2"],[0,") {\r\n   "]],"start1":1674,"start2":1674,"length1":17,"length2":16},{"diffs":[[0,"ack(data"],[-1,"2"],[0,")\r\n     "]],"start1":1712,"start2":1712,"length1":17,"length2":16}]],"length":1820,"saved":false}
{"ts":1354629650515,"patch":[[{"diffs":[[0,".mongo\r\n"],[1,"\r\n"],[0,"var Db ="]],"start1":55,"start2":55,"length1":16,"length2":18},{"diffs":[[0,"b.BSON\r\n"],[1,",   Collection = mongodb.Collection\r\n"],[0,",   Obje"]],"start1":132,"start2":132,"length1":16,"length2":53}]],"length":1859,"saved":false}
{"ts":1354629698823,"patch":[[{"diffs":[[0,"} else {"],[-1,"\r\n"],[0,"        "]],"start1":897,"start2":897,"length1":18,"length2":16},{"diffs":[[0,"    "],[-1," GridStore.exist(this.db,fileId , function(err, result) {\r\n                        console.log('store file '+fileId+\" status :\"+result)\r\n                          \r\n                        });"],[0,"\r\n  "]],"start1":924,"start2":924,"length1":200,"length2":8}]],"length":1665,"saved":false}
{"ts":1354629712007,"patch":[[{"diffs":[[0,"lse {       "],[1,"\r\n"],[0,"            "]],"start1":900,"start2":900,"length1":24,"length2":26},{"diffs":[[0,"            "],[1,"        console.log(result)"],[0,"\r\n          "]],"start1":918,"start2":918,"length1":24,"length2":51}]],"length":1694,"saved":false}
