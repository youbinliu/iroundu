{"ts":1355319276893,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var mongoose = require(\"mongoose\")\r\n,mongodb = mongoose.mongo\r\n\r\nvar Db = mongodb.Db\r\n,   Server = mongodb.Server\r\n,   BSON = mongodb.BSON\r\n,   Collection = mongodb.Collection\r\n,   ObjectID = mongodb.ObjectID\r\n,   GridStore = mongodb.GridStore\r\n\r\n\r\nvar FileUpload = function (root) {\r\n    this.root = root\r\n    this.db = new Db('iroundu', new Server(\"localhost\", 27017, {auto_reconnect:true}, {}));\r\n};\r\n\r\nFileUpload.prototype.root = 'fs'\r\n\r\nFileUpload.prototype.insertMp3 = function (data, callback) {\r\n        var fileId = new ObjectID();\r\n        var gridStore = new GridStore(this.db,fileId , 'w',{ root:this.root,\"content_type\":data.type,\"chunk_size\":data.length});\r\n        gridStore.open(function (err, gridStore) {\r\n            gridStore.write(data, function (err,gridStore) {\r\n                gridStore.close(function (err, result) {\r\n                    if (err) {\r\n                        console.log(err);\r\n                    } else {       \r\n                        callback(result);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n};\r\n\r\n\r\nFileUpload.prototype.read = function (fileId, callback) {\r\n    var gridStore = new GridStore(this.db, new ObjectID(fileId),'r',{root:this.root});\r\n    gridStore.open(function (err, gridStore) {\r\n        if(err){\r\n            //console.log(err);\r\n            callback(err);\r\n        }else{\r\n            // Set the pointer of the read head to the start of the gridstored file\r\n            gridStore.seek(0, function() {\r\n                // Read the entire file\r\n                gridStore.read(function(err,data) {\r\n                    callback(null,gridStore.contentType,data)\r\n                });\r\n            })\r\n        }\r\n    });\r\n};\r\n\r\nFileUpload.prototype.delete = function(fileId){\r\n    var gridStore = new GridStore(this.db, new ObjectID(fileId),'r',{root:this.root});\r\n    gridStore.open(function (err, gridStore) {\r\n        if(err){\r\n            //console.log(err);\r\n        }else{\r\n            gridStore.unlink(function(err, result) {\r\n                //callback(result)\r\n            })\r\n        }\r\n    })\r\n}\r\n\r\nexports.FileUpload = FileUpload;"]],"start1":0,"start2":0,"length1":0,"length2":2134}]],"length":2134}
